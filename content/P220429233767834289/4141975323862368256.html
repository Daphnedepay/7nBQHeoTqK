<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">示例前提</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">从url中提取Host子字符串。分别使用三种方式依次测试内存分配情况
测试方式依次是：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">使用span和stringpool</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">只使用span</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">使用Uri方式</section></li></ul>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">测试环境：win10、Rider2023.3.2、net7、[nuget]BenchmarkDotNet、[nuget]CommunityToolkit.HighPerformance</p>
</blockquote>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left-color: rgb(239, 112, 96); background: #fff9f9;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">工具包参考：https://learn.microsoft.com/zh-cn/dotnet/communitytoolkit/high-performance/introduction</p>
</blockquote>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">示例代码</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">MemoryDiagnoser(false)</span>]<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Benchmarks</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Params(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"https://blog.dotnetydd.com"</span>,&nbsp;<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"https://blog.dotnetydd.com/posts/1231123"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"https://blog.dotnetydd.com/cates/23"</span>)</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;Url&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Benchmark</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">GetHost_WithStringPool</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;prefixOffset&nbsp;=&nbsp;Url.AsSpan().IndexOf(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">stackalloc</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">char</span>[]&nbsp;{<span class="hljs-string" style="color: #98c379; line-height: 26px;">':'</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;startIndex&nbsp;=&nbsp;prefixOffset&nbsp;==&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">-1</span>&nbsp;?&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>&nbsp;:&nbsp;prefixOffset&nbsp;+&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">3</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;endIndex&nbsp;=&nbsp;Url.AsSpan(startIndex).IndexOf(<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;span =&nbsp;endIndex&nbsp;==&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">-1</span>&nbsp;?&nbsp;Url.AsSpan(startIndex)&nbsp;:&nbsp;Url.AsSpan(startIndex,&nbsp;endIndex);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;StringPool.Shared.GetOrAdd(span);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Benchmark</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">GetHost_WithSpan</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;prefixOffset&nbsp;=&nbsp;Url.AsSpan().IndexOf(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">stackalloc</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">char</span>[]&nbsp;{<span class="hljs-string" style="color: #98c379; line-height: 26px;">':'</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;startIndex&nbsp;=&nbsp;prefixOffset&nbsp;==&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">-1</span>&nbsp;?&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>&nbsp;:&nbsp;prefixOffset&nbsp;+&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">3</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;endIndex&nbsp;=&nbsp;Url.AsSpan(startIndex).IndexOf(<span class="hljs-string" style="color: #98c379; line-height: 26px;">'/'</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;span =&nbsp;endIndex&nbsp;==&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">-1</span>&nbsp;?&nbsp;Url.AsSpan(startIndex)&nbsp;:&nbsp;Url.AsSpan(startIndex,&nbsp;endIndex);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;span.ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Benchmark</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">GetHost</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;uri&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Uri(Url);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;uri.Host;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; border-bottom: 2px solid rgb(239, 112, 96); font-size: 1.3em;"><span class="prefix" style="display: none;"></span><span class="content" style="display: inline-block; font-weight: bold; background: rgb(239, 112, 96); color: #ffffff; padding: 3px 10px 1px; border-top-right-radius: 3px; border-top-left-radius: 3px; margin-right: 3px;">性能对比</span><span class="suffix"></span><span style="display: inline-block; vertical-align: bottom; border-bottom: 36px solid #efebe9; border-right: 20px solid transparent;"> </span></h2>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20230203/20230203160257303.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
</section>