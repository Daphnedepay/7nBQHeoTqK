<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">前言</span><span class="suffix"></span></h1>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">OAuth是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用。具体的介绍可以参考<a href="https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">阮一峰</a>的相关文章。我不会在这里为您解释 OAuth 2.0 和 OpenId Connect 的工作原理，但我会为您解释如何实现内部规范，至少是基础知识和基础知识。我们将要构建的授权服务器非常简单，但却是完整的。</p>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">准备工作</span><span class="suffix"></span></h1>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">首先，我们需要准备两个服务，在此教程中，我们都使用NET6环境和ASP.NET Core MVC</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Authorization Server</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Client App</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">客户端</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">新建ASP.NET CORE MVC应用程序。</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">安装OIDC包
<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">Microsoft.AspNetCore.Authentication.OpenIdConnect</code></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在配置ServiceCollection的地方注入对应的服务</section></li></ul>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; background: rgba(0, 0, 0, 0.05); padding-top: 10px; padding-bottom: 10px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px; border-left: 2px solid #888; border-right: 2px solid #888; padding-left: 1em; color: #777;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; text-align: justify; margin: 0px; color: black; line-height: 26px;">这里我们使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">IHostingStartup</code>来增强启动功能</p>
</blockquote>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">assembly:&nbsp;HostingStartup(typeof(DncyTemplate.Mvc.Infra.Authorization.AuthorizationHostingStartup))</span>]<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">namespace</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">DncyTemplate.Mvc.Infra.Authorization</span>;<br><br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">AuthorizationHostingStartup</span>&nbsp;:&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">IHostingStartup</span><br>{<br>&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Configure</span>(<span class="hljs-params" style="line-height: 26px;">IWebHostBuilder&nbsp;builder</span>)</span><br>&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.ConfigureServices((_,&nbsp;services)&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;services.AddAuthentication(config&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.DefaultScheme&nbsp;=&nbsp;CookieAuthenticationDefaults.AuthenticationScheme;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config.DefaultChallengeScheme&nbsp;=&nbsp;OpenIdConnectDefaults.AuthenticationScheme;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.AddCookie(CookieAuthenticationDefaults.AuthenticationScheme,&nbsp;options&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.Events&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;CookieAuthenticationEvents<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OnValidatePrincipal&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">async</span>&nbsp;cookieCtx&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;now&nbsp;=&nbsp;DateTimeOffset.UtcNow;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;expiresAt&nbsp;=&nbsp;cookieCtx.Properties.GetTokenValue(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"expires_at"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTimeOffset&nbsp;accessTokenExpiration&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrEmpty(expiresAt)&nbsp;?&nbsp;DateTimeOffset.Now.AddSeconds(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">300</span>)&nbsp;:&nbsp;DateTimeOffset.Parse(expiresAt);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;timeRemaining&nbsp;=&nbsp;accessTokenExpiration.Subtract(now);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;refreshThresholdMinutes&nbsp;=&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">5</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;refreshThreshold&nbsp;=&nbsp;TimeSpan.FromMinutes(refreshThresholdMinutes);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;TODO&nbsp;can&nbsp;use&nbsp;refresh_token&nbsp;get&nbsp;new&nbsp;token</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(timeRemaining&nbsp;&lt;&nbsp;refreshThreshold)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cookieCtx.RejectPrincipal();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">await</span>&nbsp;cookieCtx.HttpContext.SignOutAsync();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.AddOpenIdConnect(OpenIdConnectDefaults.AuthenticationScheme,&nbsp;options&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;OAuth2服务地址</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.Authority&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:9001"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;客户端id&nbsp;自定义</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.ClientId&nbsp;=&nbsp;AppConstant.SERVICE_NAME;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;secret&nbsp;自定义</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.ClientSecret&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"123456789"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.ResponseType&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.CallbackPath&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"/signin-oidc"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.SaveTokens&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.UseTokenLifetime&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.TokenValidationParameters&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenValidationParameters<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuerSigningKey&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuer&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidIssuer&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:9001"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateAudience&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidAudience&nbsp;=&nbsp;AppConstant.SERVICE_NAME,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SignatureValidator&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">delegate</span>&nbsp;(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;token,&nbsp;TokenValidationParameters&nbsp;validationParameters)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;jwt&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;JwtSecurityToken(token);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;jwt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;}<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">在上面的代码中，我使用 AddOpenIdConnect 扩展来通知 ASP.NET Core 在找到任何操作方法或控制器上的任何 Authorize 属性时将应用程序重定向到授权服务器。我将使用 Cookies 作为默认身份验证方案，并将 OpenIdConnect 作为默认质询方案。</p>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">认证授权服务</span><span class="suffix"></span></h1>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">打开 Visual Studio 并创建一个名为 OAuth20.Server 的空 ASP.NET Core 应用程序</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">目录结构</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20221105/20221105205659319.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">然后安装包：<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">System.IdentityModel.Tokens.Jwt</code></p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">OAuth 2.0 的主要角色是客户端，这里的客户端是资源所有者使用的应用程序，资源所有者是使用该应用程序的人。所以我们在models目录下新建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">Client.cs</code></p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Client</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;ClientName&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;需要和客户端AddOpenIdConnect中的一致</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;ClientId&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;需要和客户端AddOpenIdConnect中的一致</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;ClientSecret&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;GrantType&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;IsActive&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;AllowedScopes&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;ClientUri&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;按规范这个字段应该是字符串数组，暂时用字串代替</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;RedirectUri&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">OpenId Connect建立在OAuth2.0协议之上，其主要目的是对用户进行身份验证。客户端的AddOpenIdConnect扩展来验证客户端应用程序中的用户，此扩展扫描端点具有<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">.wellknown/openid-configuration</code>，并且此端点应返回json响应以及OpenId Connect所需的所有信息。具体参见：<a href="https://openid.net/specs/openid-connect-discovery-1_0.html" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">discovery端点</a>。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">在Endpoints目录中新建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">DiscoveryResponse.cs</code>文件</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">DiscoveryResponse</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;issuer&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;authorization_endpoint&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;token_endpoint&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;token_endpoint_auth_methods_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;token_endpoint_auth_signing_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;userinfo_endpoint&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;check_session_iframe&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;end_session_endpoint&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;jwks_uri&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;registration_endpoint&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;scopes_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;response_types_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;acr_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;subject_types_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;userinfo_signing_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;userinfo_encryption_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;userinfo_encryption_enc_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;id_token_signing_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;id_token_encryption_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;id_token_encryption_enc_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;request_object_signing_alg_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;display_values_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;claim_types_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;claims_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;claims_parameter_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;service_documentation&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IList&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;ui_locales_supported&nbsp;{&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">get</span>;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">set</span>;&nbsp;}<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">此模型中，比较重要的几个是：</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">issuer (颁发者是身份提供程序的域名)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">authorization_endpoint (验证客户端的终结点)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">token_endpoint (将身份令牌和访问令牌返回给客户端)</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">接下来我们创建并实现<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">authorization_endpoint</code> 和 <code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">token_endpoint</code></p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 22px; color: #009688; padding-left: 10px; margin: 1em auto; border-left: 3px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">discovery、authorization和token 终结点</span><span class="suffix"></span></h2>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px; margin: 0.6em auto; padding-left: 10px; border-left: 2px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">1.发现端点</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">新建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">DiscoveryEndpointController</code>。这里作为示例我们写死固定值</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">const</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;DOMAIN&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:9001"</span>;<br><br><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;.well-known/openid-configuration</span><br>[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">HttpGet(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"~/.well-known/openid-configuration"</span>)</span>]<br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IActionResult&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">GetConfiguration</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;response&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;DiscoveryResponse<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;issuer&nbsp;=&nbsp;DOMAIN,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;authorization_endpoint&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$"<span class="hljs-subst" style="color: #e06c75; line-height: 26px;">{DOMAIN}</span>/Home/Authorize"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_endpoint&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$"<span class="hljs-subst" style="color: #e06c75; line-height: 26px;">{DOMAIN}</span>/Home/Token"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_endpoint_auth_methods_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"client_secret_basic"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"private_key_jwt"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token_endpoint_auth_signing_alg_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"RS256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"ES256"</span>&nbsp;},<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;acr_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"urn:mace:incommon:iap:silver"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"urn:mace:incommon:iap:bronze"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response_types_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code&nbsp;id_token"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"id_token"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"token&nbsp;id_token"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subject_types_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"public"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"pairwise"</span>&nbsp;},<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userinfo_encryption_enc_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"A128CBC-HS256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"A128GCM"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_token_signing_alg_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"RS256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"ES256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"HS256"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_token_encryption_alg_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"RSA1_5"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"A128KW"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_token_encryption_enc_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"A128CBC-HS256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"A128GCM"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request_object_signing_alg_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"none"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"RS256"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"ES256"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display_values_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"page"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"popup"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;claim_types_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"normal"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"distributed"</span>&nbsp;},<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scopes_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"openid"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"profile"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"email"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"address"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"phone"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"offline_access"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;claims_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"sub"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"iss"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"auth_time"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"acr"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"name"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"given_name"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"family_name"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"nickname"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"profile"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"picture"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"website"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"email"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"email_verified"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"locale"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"zoneinfo"</span>&nbsp;},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;claims_parameter_supported&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;service_documentation&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$"<span class="hljs-subst" style="color: #e06c75; line-height: 26px;">{DOMAIN}</span>/connect/service_documentation.html"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ui_locales_supported&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"en-US"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"zh-CN"</span>&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;Json(response);<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">发现终结点需要返回json，请求路径为<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">~/.well-known/openid-configuration</code>。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px; margin: 0.6em auto; padding-left: 10px; border-left: 2px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">2. 补充GrantTypes</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">AuthorizationGrantTypes对应OAuth2.0的四种模式</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">enum</span>&nbsp;AuthorizationGrantTypesEnum&nbsp;:&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">byte</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Description(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"code"</span>)</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;Code,<br><br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Description(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"Implicit"</span>)</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;Implicit,<br><br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Description(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"ClientCredentials"</span>)</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;ClientCredentials,<br><br>&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">Description(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"ResourceOwnerPassword"</span>)</span>]<br>&nbsp;&nbsp;&nbsp;&nbsp;ResourceOwnerPassword<br>}<br></code></pre>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px; margin: 0.6em auto; padding-left: 10px; border-left: 2px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">3. authorization endpoint, token endpoint</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">AddOpenIdConnect扩展查找它的第二个终结点是授权终结点，此终结点的任务是验证客户端。在深入之前，让我们创建客户端存储对象，此对象将保存所有想要使用授权服务器的客户端。</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">ClientStore</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IEnumerable&lt;Client&gt;&nbsp;Clients&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>[]<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Client<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClientName&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"DncyTemplate.Mvc"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;需要和客户端配置一致</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClientId&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"DncyTemplate.Mvc"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;需要和客户端配置一致</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClientSecret&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"123456789"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AllowedScopes&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>[]{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"openid"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"profile"</span>,<span class="hljs-string" style="color: #98c379; line-height: 26px;">"access_mvc"</span>},<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;指定方式为授权码模式</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GrantType&nbsp;=&nbsp;GrantType.Code,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IsActive&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClientUri&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:5001"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RedirectUri&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:5001/signin-oidc"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">ClientUri和RedirectUri应该提到我们之前在本文开头创建的客户端应用程序。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">接下来新建<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">AuthorizeResultService</code></p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">AuthorizeResultService</span>:&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">IAuthorizeResultService</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;keyAlg&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"66007d41-6924-49f2-ac0c-e63c4b1a1730"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">readonly</span>&nbsp;ClientStore&nbsp;_clientStore&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;ClientStore();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">readonly</span>&nbsp;ICodeStoreService&nbsp;_codeStoreService;<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">AuthorizeResultService</span>(<span class="hljs-params" style="line-height: 26px;">ICodeStoreService&nbsp;codeStoreService</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_codeStoreService&nbsp;=&nbsp;codeStoreService;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;AuthorizeResponse&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">AuthorizeRequest</span>(<span class="hljs-params" style="line-height: 26px;">IHttpContextAccessor&nbsp;httpContextAccessor,&nbsp;AuthorizationRequest&nbsp;authorizationRequest</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AuthorizeResponse&nbsp;response&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;AuthorizeResponse();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(httpContextAccessor&nbsp;==&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;ErrorTypeEnum.ServerError.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;client&nbsp;=&nbsp;VerifyClientById(authorizationRequest.client_id);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!client.IsSuccess)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;client.ErrorDescription;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrEmpty(authorizationRequest.response_type)&nbsp;||&nbsp;authorizationRequest.response_type&nbsp;!=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;ErrorTypeEnum.InvalidRequest.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.ErrorDescription&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"response_type&nbsp;is&nbsp;required&nbsp;or&nbsp;is&nbsp;not&nbsp;valid"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!authorizationRequest.redirect_uri.IsRedirectUriStartWithHttps()&nbsp;&amp;&amp;&nbsp;!httpContextAccessor.HttpContext.Request.IsHttps)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;ErrorTypeEnum.InvalidRequest.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.ErrorDescription&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"redirect_url&nbsp;is&nbsp;not&nbsp;secure,&nbsp;MUST&nbsp;be&nbsp;TLS"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;scopes&nbsp;=&nbsp;authorizationRequest.scope.Split(<span class="hljs-string" style="color: #98c379; line-height: 26px;">'&nbsp;'</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;clientScopes&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">from</span>&nbsp;m&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">in</span>&nbsp;client.Client.AllowedScopes<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">where</span>&nbsp;scopes.Contains(m)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">select</span>&nbsp;m;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!clientScopes.Any())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;ErrorTypeEnum.InValidScope.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.ErrorDescription&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"scopes&nbsp;are&nbsp;invalids"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(httpContextAccessor.HttpContext&nbsp;!=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;nonce&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Query[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"nonce"</span>].ToString();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;code&nbsp;=&nbsp;_codeStoreService.GenerateAuthorizationCode(authorizationRequest.client_id,&nbsp;clientScopes.ToList());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(code&nbsp;==&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Error&nbsp;=&nbsp;ErrorTypeEnum.TemporarilyUnAvailable.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.RedirectUri&nbsp;=&nbsp;client.Client.RedirectUri&nbsp;+&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"?response_type=code"</span>&nbsp;+&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"&amp;state="</span>&nbsp;+&nbsp;authorizationRequest.state;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Code&nbsp;=&nbsp;code;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.State&nbsp;=&nbsp;authorizationRequest.state;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.RequestedScopes&nbsp;=&nbsp;clientScopes.ToList();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.Nonce&nbsp;=&nbsp;nonce;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;response;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;TokenResponse&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">GenerateToken</span>(<span class="hljs-params" style="line-height: 26px;">IHttpContextAccessor&nbsp;httpContextAccessor</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TokenRequest&nbsp;request&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenRequest();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(httpContextAccessor.HttpContext&nbsp;!=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.CodeVerifier&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code_verifier"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.ClientId&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"client_id"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.ClientSecret&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"client_secret"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.Code&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"code"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.GrantType&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"grant_type"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.RedirectUri&nbsp;=&nbsp;httpContextAccessor.HttpContext.Request.Form[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"redirect_uri"</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;checkClientResult&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">this</span>.VerifyClientById(request.ClientId,&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>,&nbsp;request.ClientSecret);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!checkClientResult.IsSuccess)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenResponse&nbsp;{&nbsp;Error&nbsp;=&nbsp;checkClientResult.Error,&nbsp;ErrorDescription&nbsp;=&nbsp;checkClientResult.ErrorDescription&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;check&nbsp;code&nbsp;from&nbsp;the&nbsp;Concurrent&nbsp;Dictionary</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;clientCodeChecker&nbsp;=&nbsp;_codeStoreService.GetClientDataByCode(request.Code);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(clientCodeChecker&nbsp;==&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenResponse&nbsp;{&nbsp;Error&nbsp;=&nbsp;ErrorTypeEnum.InvalidGrant.GetEnumDescription()&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(request.ClientId&nbsp;!=&nbsp;clientCodeChecker.ClientId)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenResponse&nbsp;{&nbsp;Error&nbsp;=&nbsp;ErrorTypeEnum.InvalidGrant.GetEnumDescription()&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JwtSecurityToken&nbsp;id_token&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(clientCodeChecker.IsOpenId)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>&nbsp;iat&nbsp;=&nbsp;(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>)DateTime.UtcNow.Subtract(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;DateTime(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1970</span>,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>)).TotalSeconds;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;amrs&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"pwd"</span>&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;key&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;SymmetricSecurityKey(Encoding.UTF8.GetBytes(keyAlg));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;credentials&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;SigningCredentials(key,&nbsp;SecurityAlgorithms.HmacSha256);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;claims&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;List&lt;Claim&gt;()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Claim(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"sub"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"856933325856"</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Claim(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"given_name"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Mohammed&nbsp;Ahmed&nbsp;Hussien"</span>),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Claim(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"iat"</span>,&nbsp;iat.ToString(),&nbsp;ClaimValueTypes.Integer),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Claim(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"nonce"</span>,&nbsp;clientCodeChecker.Nonce)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">foreach</span>&nbsp;(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;amr&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">in</span>&nbsp;amrs)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;claims.Add(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;Claim(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"amr"</span>,&nbsp;amr));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_token&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;JwtSecurityToken(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:9001"</span>,&nbsp;request.ClientId,&nbsp;claims,&nbsp;signingCredentials:&nbsp;credentials,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires:&nbsp;DateTime.UtcNow.AddMinutes(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>.Parse(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"5"</span>)));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;key_at&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;SymmetricSecurityKey(Encoding.UTF8.GetBytes(keyAlg));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;credentials_at&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;SigningCredentials(key_at,&nbsp;SecurityAlgorithms.HmacSha256);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;claims_at&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;List&lt;Claim&gt;();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;access_token&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;JwtSecurityToken(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"https://localhost:9001"</span>,&nbsp;request.ClientId,&nbsp;claims_at,&nbsp;signingCredentials:&nbsp;credentials_at,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires:&nbsp;DateTime.UtcNow.AddMinutes(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>.Parse(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"5"</span>)));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_codeStoreService.RemoveClientDataByCode(request.Code);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;TokenResponse<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_token&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;JwtSecurityTokenHandler().WriteToken(access_token),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;id_token&nbsp;=&nbsp;id_token&nbsp;!=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>&nbsp;?&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;JwtSecurityTokenHandler().WriteToken(id_token)&nbsp;:&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;=&nbsp;request.Code<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;CheckClientResult&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">VerifyClientById</span>(<span class="hljs-params" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;clientId,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;checkWithSecret&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;clientSecret&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span></span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CheckClientResult&nbsp;result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;CheckClientResult()&nbsp;{&nbsp;IsSuccess&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrWhiteSpace(clientId))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;client&nbsp;=&nbsp;_clientStore.Clients.FirstOrDefault(x&nbsp;=&gt;&nbsp;x.ClientId.Equals(clientId,&nbsp;StringComparison.OrdinalIgnoreCase));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(client&nbsp;!=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(checkWithSecret&nbsp;&amp;&amp;&nbsp;!<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrEmpty(clientSecret))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;hasSamesecretId&nbsp;=&nbsp;client.ClientSecret.Equals(clientSecret,&nbsp;StringComparison.InvariantCulture);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!hasSamesecretId)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.Error&nbsp;=&nbsp;ErrorTypeEnum.InvalidClient.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(client.IsActive)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.IsSuccess&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.Client&nbsp;=&nbsp;client;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.ErrorDescription&nbsp;=&nbsp;ErrorTypeEnum.UnAuthoriazedClient.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result.ErrorDescription&nbsp;=&nbsp;ErrorTypeEnum.AccessDenied.GetEnumDescription();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">AuthorizeResultService中用到了CodeStoreService</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">public class InMemoryCodeStoreService: ICodeStoreService
{
    // 临时用并发字段存储
    private readonly ConcurrentDictionary&lt;string, AuthorizationCode&gt; _codeIssued = new ConcurrentDictionary&lt;string, AuthorizationCode&gt;();
    private readonly ClientStore _clientStore = new ClientStore();

    public string GenerateAuthorizationCode(string clientId, IList&lt;string&gt; requestedScope)
    {
        var client = _clientStore.Clients.FirstOrDefault(x =&gt; x.ClientId == clientId);

        if (client != null)
        {
            var code = Guid.NewGuid().ToString();

            var authoCode = new AuthorizationCode
            {
                ClientId = clientId,
                RedirectUri = client.RedirectUri,
                RequestedScopes = requestedScope,
            };

            _codeIssued[code] = authoCode;

            return code;
        }
        return null;

    }

    public AuthorizationCode GetClientDataByCode(string key)
    {
        if (_codeIssued.TryGetValue(key, out var authorizationCode))
        {
            return authorizationCode;
        }
        return null;
    }

    public AuthorizationCode RemoveClientDataByCode(string key)
    {
        _codeIssued.TryRemove(key, out _);
        return null;
    }

    public AuthorizationCode UpdatedClientDataByCode(string key, IList&lt;string&gt; requestdScopes, string userName, string password = null, string nonce = null)
    {
        var oldValue = GetClientDataByCode(key);

        if (oldValue != null)
        {
            // check the requested scopes with the one that are stored in the Client Store 
            var client = _clientStore.Clients.FirstOrDefault(x =&gt; x.ClientId == oldValue.ClientId);

            if (client != null)
            {
                var clientScope = ( from m in client.AllowedScopes
                                    where requestdScopes.Contains(m)
                                    select m ).ToList();

                if (!clientScope.Any())
                    return null;

                AuthorizationCode newValue = new AuthorizationCode
                {
                    ClientId = oldValue.ClientId,
                    CreationTime = oldValue.CreationTime,
                    IsOpenId = requestdScopes.Contains("openId") || requestdScopes.Contains("profile"),
                    RedirectUri = oldValue.RedirectUri,
                    RequestedScopes = requestdScopes,
                    Nonce = nonce
                };

                var claims = new List&lt;Claim&gt;();

                if (newValue.IsOpenId)
                {
                    // TODO
                    // Add more claims to the claims

                }

                var claimIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
                newValue.Subject = new ClaimsPrincipal(claimIdentity);
             
                var result = _codeIssued.TryUpdate(key, newValue, oldValue);

                if (result)
                    return newValue;
                return null;
            }
        }
        return null;
    }
}
</code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">将上述两个服务注入应用程序中</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">builder.Services.AddSingleton&lt;ICodeStoreService,&nbsp;InMemoryCodeStoreService&gt;();<br>builder.Services.AddScoped&lt;IAuthorizeResultService,&nbsp;AuthorizeResultService&gt;();<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">在Home控制器中新建授权控制器和token控制器，还有登录页面</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><br>[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">HttpGet</span>]<br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IActionResult&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Login</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;View();<br>}<br><br><br>[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">HttpPost</span>]<br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">async</span>&nbsp;Task&lt;IActionResult&gt;&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Login</span>(<span class="hljs-params" style="line-height: 26px;">OpenIdConnectLoginRequest&nbsp;loginRequest</span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;here&nbsp;I&nbsp;have&nbsp;to&nbsp;check&nbsp;if&nbsp;the&nbsp;username&nbsp;and&nbsp;passowrd&nbsp;is&nbsp;correct</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;and&nbsp;I&nbsp;will&nbsp;show&nbsp;you&nbsp;how&nbsp;to&nbsp;integrate&nbsp;the&nbsp;ASP.NET&nbsp;Core&nbsp;Identity</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;With&nbsp;our&nbsp;framework</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;result&nbsp;=&nbsp;_codeStoreService.UpdatedClientDataByCode(loginRequest.Code,&nbsp;loginRequest.RequestedScopes,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loginRequest.UserName,&nbsp;nonce:&nbsp;loginRequest.Nonce);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(result&nbsp;!=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loginRequest.RedirectUri&nbsp;=&nbsp;loginRequest.RedirectUri&nbsp;+&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"&amp;code="</span>&nbsp;+&nbsp;loginRequest.Code;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;Redirect(loginRequest.RedirectUri);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;RedirectToAction(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Error"</span>,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;{&nbsp;error&nbsp;=&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"invalid_request"</span>&nbsp;});<br>}<br><br><br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IActionResult&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Authorize</span>(<span class="hljs-params" style="line-height: 26px;">AuthorizationRequest&nbsp;authorizationRequest</span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;result&nbsp;=&nbsp;_authorizeResultService.AuthorizeRequest(_httpContextAccessor,&nbsp;authorizationRequest);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(result.HasError)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;RedirectToAction(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Error"</span>,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;{&nbsp;error&nbsp;=&nbsp;result.Error&nbsp;});<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;loginModel&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;OpenIdConnectLoginRequest<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RedirectUri&nbsp;=&nbsp;result.RedirectUri,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Code&nbsp;=&nbsp;result.Code,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RequestedScopes&nbsp;=&nbsp;result.RequestedScopes,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nonce&nbsp;=&nbsp;result.Nonce<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;View(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Login"</span>,&nbsp;loginModel);<br>}<br><br><br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;IActionResult&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Token</span>(<span class="hljs-params" style="line-height: 26px;"></span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;result&nbsp;=&nbsp;_authorizeResultService.GenerateToken(_httpContextAccessor);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(result.HasError)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;Json(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"0"</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;Json(result);<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">以上逻辑是，当AuthorizeRequest方法返回成功的响应时，我们将用户返回到登录视图，用户填写信息登录后重定向到目标url，然后<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">AddOpenIdConnect</code>收到授权结果后，调用token端点获取id_token和access_token。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 22px; color: #009688; padding-left: 10px; margin: 1em auto; border-left: 3px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">效果</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">最后在客户端需要授权的action上使用<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">Authorize</code>标记。当访问此action时，如果没有经过授权，会跳转至授权服务器进行授权。</p>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20221105/20221105213028556.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://cdn.jsdelivr.net/gh/Daphnedepay/7nBQHeoTqK/20221105/20221105213214457.png" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
</section>