<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">查看sql server中执行的语句的情况的脚本，可与排查性能，死锁问题</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">SELECT</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">DISTINCT</span>&nbsp;r.scheduler_id,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.status,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.session_id&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;SPID,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.blocking_session_id&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;BlkBy,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp.program_name&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;ProgramName,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">COALESCE</span>(sp.LOGINAME,&nbsp;sp.nt_username)&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;HostName,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.cpu_time&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;[CPU&nbsp;<span class="hljs-built_in" style="color: #e6c07b; line-height: 26px;">Time</span>(ms)],<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">DATEDIFF</span>(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">minute</span>,&nbsp;r.start_time,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">GETDATE</span>())&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">Duration</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.start_time,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.total_elapsed_time&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;Total_Execution_Time,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.reads&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">Reads</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.writes&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;Writes,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.logical_reads,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q.text,&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">--FULL&nbsp;TEXT</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d.name&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;DataBaseName<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">FROM</span>&nbsp;sys.dm_exec_requests&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;r<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">CROSS</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">APPLY</span>&nbsp;sys.dm_exec_sql_text(&nbsp;sql_handle&nbsp;)&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;q<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">LEFT</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">JOIN</span>&nbsp;sys.databases&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;d&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">ON</span>&nbsp;r.database_id&nbsp;=&nbsp;d.database_id<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">LEFT</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">OUTER</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">JOIN</span>&nbsp;master.dbo.sysprocesses&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AS</span>&nbsp;sp&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">ON</span>&nbsp;SP.spid&nbsp;=&nbsp;r.session_id<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">WHERE</span>&nbsp;r.session_id&nbsp;&gt;&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">50</span><br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AND</span>&nbsp;r.session_id&nbsp;&lt;&gt;&nbsp;@@SPID<br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AND</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">COALESCE</span>(sp.LOGINAME,&nbsp;sp.nt_username)&nbsp;&lt;&gt;&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">''</span><br>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">AND</span>&nbsp;d.name&nbsp;=&nbsp;&lt;数据库名称&gt;<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">ORDER</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">BY</span>&nbsp;r.total_elapsed_time&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">DESC</span>;<br></code></pre>
</section>