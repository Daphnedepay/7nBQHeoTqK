<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">使用异常作为方法执行返回的弊端</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">异常缓慢、繁琐，并且经常导致意想不到的行为。甚至 Microsoft 官方文档也告诉您要限制对异常的使用。
大多数时候，您希望在不允许异常传播的情况下同时处理成功和失败的情况。你可能想知道“如果我不使用异常，我怎么能告诉调用者函数出了问题？。另外的一种代替方式就是使用结果类型进行封装。</p>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">结果类型</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">当我们的函数需要表示两种状态：成功结果和结果时，我们可以使用泛型对其进行建模，<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; color: #1e6bb8; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all;">Result&lt;T, E&gt;</code> 其中 T 表示返回值，E 表示错误。获取用户的函数可能如下所示：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">async</span>&nbsp;Result&lt;User,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">FindByEmail</span>(<span class="hljs-params" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;email</span>)</span>&nbsp;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;User&nbsp;user&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">await</span>&nbsp;context.Users.FirstOrDefaultAsync(u&nbsp;=&gt;&nbsp;EF.Functions.Like(u.Email,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">$"%<span class="hljs-subst" style="color: #e06c75; line-height: 26px;">{email}</span>%"</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>(user&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">is</span>&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"No&nbsp;user&nbsp;found"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;user;<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">Action或者调用方可以使用一下方式进行调用：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">[<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">HttpGet(<span class="hljs-meta-string" style="color: #98c379; line-height: 26px;">"{email}"</span>)</span>]<br><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">async</span>&nbsp;Task&lt;ActionResult&lt;User&gt;&gt;&nbsp;GetByEmail(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;email)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrEmpty(email))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;BadRequest(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"email&nbsp;cannot&nbsp;be&nbsp;empty"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;Result&lt;User,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&gt;&nbsp;result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">await</span>&nbsp;FindByEmail(email);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;result.Match&lt;ActionResult&lt;User&gt;&gt;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user&nbsp;=&gt;&nbsp;Ok(user),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;=&gt;&nbsp;NotFound());<br>}<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">如果您不想为错误返回字符串，而是返回不同的类型，您可以定义这些类/结构并返回它们，或者使用现有的异常类型来处理错误。返回异常会比抛出它们的代价更加低。</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">以下是结果类型一个示例：</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;record&nbsp;Result&lt;T,&nbsp;E&gt;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">readonly</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;_success;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">readonly</span>&nbsp;T&nbsp;Value;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">readonly</span>&nbsp;E&nbsp;Error;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Result</span>(<span class="hljs-params" style="line-height: 26px;">T&nbsp;v,&nbsp;E&nbsp;e,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;success</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;v;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error&nbsp;=&nbsp;e;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_success&nbsp;=&nbsp;success;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;IsOk&nbsp;=&gt;&nbsp;_success;<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;T&nbsp;Data&nbsp;=&gt;&nbsp;Value;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;E&nbsp;Errors&nbsp;=&gt;&nbsp;Error;<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;Result&lt;T,&nbsp;E&gt;&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Ok</span>(<span class="hljs-params" style="line-height: 26px;">T&nbsp;v</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>(v,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">default</span>(E),&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;Result&lt;T,&nbsp;E&gt;&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">Err</span>(<span class="hljs-params" style="line-height: 26px;">E&nbsp;e</span>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">default</span>(T),&nbsp;e,&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">implicit</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">operator</span>&nbsp;Result&lt;T,&nbsp;E&gt;(T&nbsp;v)&nbsp;=&gt;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>(v,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">default</span>(E),&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">true</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">implicit</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">operator</span>&nbsp;Result&lt;T,&nbsp;E&gt;(E&nbsp;e)&nbsp;=&gt;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">default</span>(T),&nbsp;e,&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">false</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;R&nbsp;Match&lt;R&gt;(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Func&lt;T,&nbsp;R&gt;&nbsp;success,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Func&lt;E,&nbsp;R&gt;&nbsp;failure)&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_success&nbsp;?&nbsp;success(Value)&nbsp;:&nbsp;failure(Error);<br>}<br></code></pre>
</section>