<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">需求</span><span class="suffix"></span></h2>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">拦截掉所有的xx市的访问流量；</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">拦截请求中包含敏感词的流量；</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">拦截掉黑名单中的IP；</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">拦截特定的IP地址段；</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">限制同一IP每分钟的最大请求数为n次/分钟，若一分钟内请求数超过n则认为是恶意请求，冻结该IP 1分钟；</section></li></ol>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">安装nuget包</span><span class="suffix"></span></h2>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">IP2Region  IP地址定位库</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">CacheManager.Microsoft.Extensions.Caching.Memory 缓存(使用内存换存)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">CacheManager.Serialization.Json 缓存序列化工具</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">服务注册</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;配置CacheManager</span><br>services.AddSingleton(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">typeof</span>(ICacheManager&lt;&gt;),&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">typeof</span>(BaseCacheManager&lt;&gt;));<br>services.AddSingleton(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;CacheManager.Core.ConfigurationBuilder()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithJsonSerializer()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithMicrosoftMemoryCacheHandle()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.WithExpiration(ExpirationMode.Absolute,&nbsp;TimeSpan.FromMinutes(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">5</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.Build());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>services.Configure&lt;ForwardedHeadersOptions&gt;(options&nbsp;=&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.ForwardLimit&nbsp;=&nbsp;<span class="hljs-literal" style="color: #56b6c2; line-height: 26px;">null</span>;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;限制所处理的标头中的条目数</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.ForwardedHeaders&nbsp;=&nbsp;ForwardedHeaders.XForwardedFor&nbsp;|&nbsp;ForwardedHeaders.XForwardedProto;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;X-Forwarded-For：保存代理链中关于发起请求的客户端和后续代理的信息。X-Forwarded-Proto：原方案的值&nbsp;(HTTP/HTTPS)&nbsp;&nbsp;&nbsp;&nbsp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.KnownNetworks.Clear();&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;从中接受转接头的已知网络的地址范围。&nbsp;使用无类别域际路由选择&nbsp;(CIDR)&nbsp;表示法提供&nbsp;IP&nbsp;范围。使用CDN时应清空</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options.KnownProxies.Clear();&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;从中接受转接头的已知代理的地址。&nbsp;使用&nbsp;KnownProxies&nbsp;指定精确的&nbsp;IP&nbsp;地址匹配。使用CDN时应清空</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">使用中间件</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;">app.UseForwardedHeaders().UseCertificateForwarding();&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;转发请求头和证书</span><br></code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">创建一个过滤器</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">创建一个名为FirewallAttribute的过滤器，继承自ActionFilterAttribute，并重写OnActionExecuting方法</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">FirewallAttribute</span>&nbsp;:&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">ActionFilterAttribute</span><br>{<br>&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;ICacheManager&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>&gt;&nbsp;_cacheManager;<br>&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">override</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">OnActionExecuting</span>(<span class="hljs-params" style="line-height: 26px;">ActionExecutingContext&nbsp;context</span>)</span><br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;request&nbsp;=&nbsp;context.HttpContext.Request;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_cacheManager&nbsp;=&nbsp;context.HttpContext.RequestServices.GetService&lt;ICacheManager&lt;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">int</span>&gt;&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(context.Filters.Any(m&nbsp;=&gt;&nbsp;m.ToString().Contains(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">nameof</span>(AllowAccessFirewallAttribute))))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;白名单直接跳过</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">region</span>&nbsp;实现过滤指定地区的流量</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;ip&nbsp;=&nbsp;context.HttpContext.Connection.RemoteIpAddress.MapToIPv4().ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;由于X-Forwarded-For标头可能会被客户端篡改进行伪造，所以我们还需要用CDN提供的一个转发客户端真实IP并且不可篡改的标头进行双重检查，比如cloudflare的CF-Connecting-IP标头是不可被篡改的标头。</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;trueip&nbsp;=&nbsp;request.Headers[<span class="hljs-string" style="color: #98c379; line-height: 26px;">"CF-Connecting-IP"</span>].ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>.IsNullOrEmpty(trueip)&nbsp;&amp;&amp;&nbsp;ip&nbsp;!=&nbsp;trueip)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"客户端请求不合法，伪造IP："</span>&nbsp;+&nbsp;ip);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;IsInDenyArea&nbsp;需要使用IP2Region的离线库</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(ip.IsInDenyArea(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"北京"</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"访问地区限制"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">endregion</span></span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">region</span>&nbsp;敏感词</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;path&nbsp;=&nbsp;HttpUtility.UrlDecode(request.Path&nbsp;+&nbsp;request.QueryString,&nbsp;Encoding.UTF8);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(Regex.Match(path&nbsp;??&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">""</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"彩票|办证"</span>).Length&nbsp;&gt;&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>)&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;这里写死了，应该使用敏感词库</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"参数不合法！"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">endregion</span></span><br><br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">region</span>&nbsp;拦截掉黑名单中的IP</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>[]&nbsp;{&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"1.2.3.4"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"5.6.7.8"</span>&nbsp;}.Contains(ip))&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;这里也写死了&nbsp;应该有黑名单库</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"您当前所在的网络环境不支持访问本站！"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">endregion</span></span><br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">region</span>&nbsp;拦截特定的IP地址段</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//同样有一个专门存储IP地址段的文件，比如我想拦截36.149.0.0~36.149.15.255这个地址段，那怎么判断一个IP是否在这个地址段内呢？学过网络的同学肯定知道，IP地址实际上是一段32位的二进制编码，我们可以将IP地址转换成十进制后，就可以判断是否在地址段内了</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(ip.IpAddressInRange(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"36.149.0.0"</span>,&nbsp;<span class="hljs-string" style="color: #98c379; line-height: 26px;">"36.149.15.255"</span>))&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;这里也写死了&nbsp;应该有黑名单库</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"您当前所在的网络环境不支持访问本站！"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">endregion</span></span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">region</span>&nbsp;限制请求频次</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//我们需要记录每个IP的请求次数，所以这里需要用到缓存组件CacheManager，用CacheManager的好处在于可以平滑的在各种持久化库之间切换</span><br>&nbsp;&nbsp;&nbsp;&nbsp;也就是可以不动主要代码的情况下，直接从内存缓存切换到Redis或MongoDB之类的这种操作。<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;">//&nbsp;限流规则：同一IP每分钟的最大请求数为300次/分钟，若一分钟内请求数超过300则认为是恶意请求，冻结该IP&nbsp;1分钟，并且是滑动时间。&nbsp;&nbsp;&nbsp;&nbsp;</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同样也需要实现一个自定义异常以方便做同一拦截处理：<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;times&nbsp;=&nbsp;_cacheManager.AddOrUpdate(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Frequency:"</span>&nbsp;+&nbsp;ip,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>,&nbsp;i&nbsp;=&gt;&nbsp;i&nbsp;+&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">5</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;_cacheManager.Expire(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Frequency:"</span>&nbsp;+&nbsp;ip,&nbsp;ExpirationMode.Sliding,&nbsp;TimeSpan.FromSeconds(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;limit&nbsp;=&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">3</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(times&nbsp;&lt;=&nbsp;limit)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(times&nbsp;&gt;&nbsp;limit&nbsp;*&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1.2</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_cacheManager.Expire(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"Frequency:"</span>&nbsp;+&nbsp;ip,&nbsp;ExpirationMode.Sliding,&nbsp;TimeSpan.FromMinutes(<span class="hljs-number" style="color: #d19a66; line-height: 26px;">1</span>));<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;context.Result&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">new</span>&nbsp;BadRequestObjectResult(<span class="hljs-string" style="color: #98c379; line-height: 26px;">"请求频繁，稍后再试试！"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #61aeee; line-height: 26px;">#<span class="hljs-meta-keyword" style="line-height: 26px;">endregion</span></span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<br><br>&nbsp;&nbsp;}<br>}<br></code></pre>
<h2 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 22px;"><span class="prefix" style="display: none;"></span><span class="content">IP段判断</span><span class="suffix"></span></h2>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">IPv4地址是由4段0-255的数字组成的，形如：a.b.c.d(0≤a,b,c,d≤255)，IPv4也叫32位地址，为什么是32位呢，我们把每一段转换成二进制之后，它的取值范围就是00000000-11111111，所以加起来就是32位。那IP地址的本质是一个32位的二进制数，我们便可以将这个32位的二进制再转换成十进制，进行比较</p>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black;">例如：</p>
<blockquote class="multiquote-1" data-tool="mdnice编辑器" style="border: none; display: block; font-size: 0.9em; overflow: auto; overflow-scrolling: touch; border-left: 3px solid rgba(0, 0, 0, 0.4); background: rgba(0, 0, 0, 0.05); color: #6a737d; padding-top: 10px; padding-bottom: 10px; padding-left: 20px; padding-right: 10px; margin-bottom: 20px; margin-top: 20px;">
<p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0px; color: black; line-height: 26px;">以4.3.2.1为例，对应的十进制是多少呢？<br>
第一步，转换成二进制，即00000100.00000011.00000010.00000001；<br>
第二步，去掉“.”，得到完整的二进制数：00000100000000110000001000000001；<br>
第三步，再转回十进制：00000100000000110000001000000001(2)=67305985(10)；<br>
所以4.3.2.1对应的十进制数是67305985。<br>
那有没有什么更快的办法来计算这个十进制数呢？肯定是有的，就是移位操作，67305985=4&lt;&lt;24+3&lt;&lt;16+2&lt;&lt;8+1。这样就实现了IP地址转十进制数的操作，即使是128位的IPv6，也是如法炮制！</p>
</blockquote>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto; padding: 16px; color: #abb2bf; background: #282c34; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; border-radius: 0px; font-size: 12px; -webkit-overflow-scrolling: touch;"><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;summary&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;IP地址转换成数字</span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/summary&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;param&nbsp;name="addr"&gt;</span>IP地址<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/param&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;returns&gt;</span>数字,输入无效IP地址返回0<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/returns&gt;</span></span><br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">private</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">uint</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">IPToID</span>(<span class="hljs-params" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">this</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;addr</span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(!IPAddress.TryParse(addr,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">out</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">var</span>&nbsp;ip))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">byte</span>[]&nbsp;bInt&nbsp;=&nbsp;ip.GetAddressBytes();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">if</span>&nbsp;(BitConverter.IsLittleEndian)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Array.Reverse(bInt);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;BitConverter.ToUInt32(bInt,&nbsp;<span class="hljs-number" style="color: #d19a66; line-height: 26px;">0</span>);<br>}<br><br><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;summary&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;判断IP地址在不在某个IP地址段</span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/summary&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;param&nbsp;name="input"&gt;</span>需要判断的IP地址<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/param&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;param&nbsp;name="begin"&gt;</span>起始地址<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/param&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;param&nbsp;name="ends"&gt;</span>结束地址<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/param&gt;</span></span><br><span class="hljs-comment" style="color: #5c6370; font-style: italic; line-height: 26px;"><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">///</span>&nbsp;<span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;returns&gt;</span><span class="hljs-doctag" style="color: #c678dd; line-height: 26px;">&lt;/returns&gt;</span></span><br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">bool</span>&nbsp;<span class="hljs-title" style="color: #61aeee; line-height: 26px;">IpAddressInRange</span>(<span class="hljs-params" style="line-height: 26px;"><span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">this</span>&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;input,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;begin,&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">string</span>&nbsp;ends</span>)</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">uint</span>&nbsp;current&nbsp;=&nbsp;input.IPToID();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #c678dd; line-height: 26px;">return</span>&nbsp;current&nbsp;&gt;=&nbsp;begin.IPToID()&nbsp;&amp;&amp;&nbsp;current&nbsp;&lt;=&nbsp;ends.IPToID();<br>}<br><br></code></pre>
</section>